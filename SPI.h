/*
 * SPI.h
 *
 * Created: 11/4/16 4:03:46 PM
 *  Author: ianmcdoom
 */ 


#ifndef SPI_H_
#define SPI_H_

#define BUAD_SPI (28800*8)
#define UBBR_SPI ((F_CPU/2/BUAD_SPI)) //calc USART baud rate in normal Asyc mode

#define NSAMPLES 100
#define qp NSAMPLES/4
#define command 0x90
int controlcode=0XF000;

unsigned int sinw[NSAMPLES] = {0x190,0x1a9,0x1c2,0x1db,0x1f3,0x20c,0x223,0x23a,
0x251,0x266,0x27b,0x28f,0x2a2,0x2b4,0x2c4,0x2d4,
0x2e2,0x2ef,0x2fa,0x304,0x30c,0x313,0x319,0x31d,
0x31f,0x320,0x31f,0x31d,0x319,0x313,0x30c,0x304,
0x2fa,0x2ef,0x2e2,0x2d4,0x2c4,0x2b4,0x2a2,0x28f,
0x27b,0x266,0x251,0x23a,0x223,0x20c,0x1f3,0x1db,
0x1c2,0x1a9,0x190,0x177,0x15e,0x145,0x12d,0x114,
0xfd,0xe6,0xcf,0xba,0xa5,0x91,0x7e,0x6c,
0x5c,0x4c,0x3e,0x31,0x26,0x1c,0x14,0xd,
0x7,0x3,0x1,0x0,0x1,0x3,0x7,0xd,
0x14,0x1c,0x26,0x31,0x3e,0x4c,0x5c,0x6c,
0x7e,0x91,0xa5,0xba,0xcf,0xe6,0xfd,0x114,
0x12d,0x145,0x15e,0x177,0x190};
	
unsigned int trianglew[NSAMPLES] =	{0x12,0x12,0x24,0x35,0x47,0x59,0x6b,0x7c,0x8e,
	0xa0,0xb2,0xc4,0xd5,0xe7,0xf9,0x10b,0x11c,
	0x12e,0x140,0x152,0x164,0x175,0x187,0x199,0x1ab,
	0x1bd,0x1ce,0x1e0,0x1f2,0x204,0x215,0x227,0x239,
	0x24b,0x25d,0x26e,0x280,0x292,0x2a4,0x2b5,0x2c7,
	0x2d9,0x2eb,0x2fd,0x30e,0x320,0x332,0x344,0x355,
	0x367,0x379,0x367,0x355,0x344,0x332,0x320,0x30e,
	0x2fd,0x2eb,0x2d9,0x2c7,0x2b5,0x2a4,0x292,0x280,
	0x26e,0x25d,0x24b,0x239,0x227,0x215,0x204,0x1f2,
	0x1e0,0x1ce,0x1bd,0x1ab,0x199,0x187,0x175,0x164,
	0x152,0x140,0x12e,0x11c,0x10b,0xf9,0xe7,0xd5,
	0xc4,0xb2,0xa0,0x8e,0x7c,0x6b,0x59,0x47,
	0x35,0x24,0x12,0x12};

void spi_init(void){
	
	/* Setting the XCKn port pin as output, enables master mode. */
	DDRD |= (1<<PIND2)|(1<<PIND4);
	/* Set MSPI mode of operation and SPI data mode 0. */
	UCSR1C = (1<<UMSEL11)|(1<<UMSEL10)|(1<<UCSZ10)|(1<<UCPOL1);
	/* Enable receiver and transmitter. */
	UCSR1B = (1<<TXEN1);
	/* Set baud rate. */
	/* IMPORTANT: The Baud Rate must be set after the transmitter is enabled */
	UBRR1 = UBBR_SPI;
}

void send_wave(void){
	int point;
	int highN;
	int lowN;
	
	PORTD |= (1 << PIND2);
	
	for (int j=0; j<=99; j++)
	{
		point = sinw[j];
		point = (point << 2);
		point = (controlcode  | point);
		highN = (point & 0xFF00) >> 8;
		lowN = (point & 0x00FF);
		
		UCSR1A |= (1 << TXC1);
		PORTD &= ~(1 << PIND2);
		UDR1=highN;
		_delay_us(2);
		UDR1=lowN;
		_delay_us(5);
		while (!(UCSR1A & (1<<TXC1)));
		PORTD |= (1 << PIND2);
	}
}


#endif /* SPI_H_ */